{% extends 'core/base.html' %}
{% load static %}
{% load content_filters %}

{% block title %}{{ post.title }} - Post Pilot{% endblock %}

{% block extra_head %}
<style>
.markdown-content {
    line-height: 1.6;
}
.markdown-content h1, .markdown-content h2, .markdown-content h3 {
    color: #333;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
}
.markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-family: 'Courier New', monospace;
}
.markdown-content pre {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 0.375rem;
    padding: 1rem;
    overflow-x: auto;
}
.markdown-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin-left: 0;
    font-style: italic;
    color: #6c757d;
}
.markdown-content hr {
    border: none;
    border-top: 2px solid #dee2e6;
    margin: 2rem 0;
}

/* Estilos para botões de cópia */
.copy-btn {
    transition: all 0.2s ease;
}
.copy-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Animação para feedback de cópia */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.copy-feedback {
    animation: slideInRight 0.3s ease-out;
}
</style>
{% endblock %}

{% block content %}
<!-- Indicador de processamento -->
{% if post.is_processing %}
<div id="processing-banner" class="alert alert-info alert-dismissible fade show" role="alert">
    <div class="d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-3" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <div>
            <strong>Processing...</strong> 
            <span id="processing-message">A IA está melhorando este post. A página será atualizada automaticamente quando concluído.</span>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'post_list' %}">Posts</a></li>
                <li class="breadcrumb-item active">{{ post.title|truncatewords:3 }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-{% if post.post_type == 'article' %}info{% else %}primary{% endif %} me-2">
                        {{ post.get_post_type_display }}
                    </span>
                    <span class="badge bg-{% if post.status == 'published' %}success{% elif post.status == 'generated' %}warning{% elif post.status == 'scheduled' %}info{% else %}secondary{% endif %}">
                        {{ post.get_status_display }}
                    </span>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Métricas rápidas -->
                <div class="row mb-3 text-center bg-light p-2 rounded">
                    <div class="col-3">
                        <small class="text-muted d-block">Caracteres</small>
                        <strong class="text-primary">{{ post.content|length|floatformat:0 }}</strong>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">Palavras</small>
                        <strong class="text-info">{{ post.content|wordcount }}</strong>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">Leitura</small>
                        <strong class="text-success">{% widthratio post.content|wordcount 200 1 %} min</strong>
                    </div>
                    <div class="col-3">
                        <small class="text-muted d-block">Qualidade</small>
                        <span class="badge bg-{% if post.content|length > 1500 %}success{% elif post.content|length > 800 %}warning{% else %}secondary{% endif %}">
                            {% if post.content|length > 1500 %}Alta{% elif post.content|length > 800 %}Média{% else %}Básica{% endif %}
                        </span>
                    </div>
                </div>
                
                <!-- Content principal -->
                <h2 class="card-title mb-3">{{ post.title }}</h2>
                <div class="content-area">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm copy-btn" 
                                onclick="copyContent(null, 'direct', '{{ post.content|escapejs }}', 'markdown')"
                                title="Copiar conteúdo em formato Markdown">
                            <i class="bi bi-clipboard"></i> Copiar Markdown
                        </button>
                        
                        <!-- Botão Melhorar Post -->
                        <form method="post" action="{% url 'post_improve' post.id %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-success btn-sm" 
                                    onclick="return confirm('Deseja melhorar este post? O conteúdo será estendido com mais detalhes e exemplos práticos.')">
                                <i class="bi bi-arrow-up-circle"></i> Melhorar Post
                            </button>
                        </form>
                    </div>
                    <div class="border rounded p-3 bg-light markdown-content" id="post-content">
                        {% load custom_filters %}
                        {{ post.content|markdown_to_html|safe }}
                    </div>
                </div>
                
                <!-- Post Promocional (apenas para artigos) -->
                {% if post.post_type == 'article' and post.promotional_post %}
                    <div class="content-area mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">Post Promocional</h5>
                            <button type="button" class="btn btn-outline-secondary btn-sm copy-btn" 
                                    onclick="copyContent(null, 'direct', '{{ post.promotional_post|escapejs }}', 'promotional')"
                                    title="Copiar post promocional">
                                <i class="bi bi-clipboard"></i> Copiar Post Promocional
                            </button>
                        </div>
                        <div class="border rounded p-3 bg-light" style="background-color: #f8f9fa !important;">
                            <small class="text-muted d-block mb-2">Post para promover o artigo no LinkedIn:</small>
                            <div class="markdown-content">
                                {{ post.promotional_post|markdown_to_html|safe }}
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- Prompt da Imagem de Capa (apenas para artigos) -->
                {% if post.post_type == 'article' %}
                    <div class="content-area mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0">Prompt da Imagem de Capa</h5>
                            <div>
                                {% if post.cover_image_prompt %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm copy-btn me-2" 
                                            onclick="copyContent(null, 'direct', '{{ post.cover_image_prompt|escapejs }}', 'image_prompt')"
                                            title="Copiar prompt da imagem">
                                        <i class="bi bi-clipboard"></i> Copiar Prompt
                                    </button>
                                    <form method="post" action="{% url 'regenerate_image_prompt' post.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-warning btn-sm" 
                                                onclick="return confirm('Deseja regenerar o prompt da imagem de capa? Um novo prompt será criado mantendo a consistência com o tema do artigo.')">
                                            <i class="bi bi-arrow-clockwise"></i> Regenerar
                                        </button>
                                    </form>
                                {% else %}
                                    <form method="post" action="{% url 'regenerate_image_prompt' post.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-primary btn-sm" 
                                                onclick="return confirm('Deseja gerar um prompt de imagem de capa para este artigo?')">
                                            <i class="bi bi-image"></i> Gerar Prompt da Imagem
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                        {% if post.cover_image_prompt %}
                            <div class="border rounded p-3 bg-light" style="background-color: #fff8e1 !important;">
                                <small class="text-muted d-block mb-2">Prompt para gerar imagem de capa do artigo:</small>
                                <div class="font-monospace small">
                                    {{ post.cover_image_prompt|linebreaks }}
                                </div>
                            </div>
                        {% else %}
                            <div class="border rounded p-3 bg-light text-muted text-center">
                                <i class="bi bi-image" style="font-size: 2rem; opacity: 0.3;"></i>
                                <div class="mt-2">
                                    <small>Nenhum prompt de imagem gerado ainda.</small><br>
                                    <small>Clique em "Gerar Prompt da Imagem" para criar uma descrição detalhada para geração de imagem de capa.</small>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endif %}
                <script>
                function copyContent(elementId, type = 'text', directText = null, contentType = null) {
                    let textToCopy;
                    let feedbackMessage = 'Copiado para área de transferência!';
                    
                    if (directText) {
                        textToCopy = directText;
                        
                        // Definir mensagem específica baseada no tipo de conteúdo
                        if (contentType === 'markdown') {
                            feedbackMessage = 'Content Markdown copiado!';
                        } else if (contentType === 'promotional') {
                            feedbackMessage = 'Post promocional copiado!';
                        } else if (contentType === 'image_prompt') {
                            feedbackMessage = 'Prompt da imagem copiado!';
                        } else if (contentType === 'seo_title') {
                            feedbackMessage = 'Title SEO copiado!';
                        } else if (contentType === 'seo_description') {
                            feedbackMessage = 'Description SEO copiada!';
                        }
                    } else if (type === 'text') {
                        // Para conteúdo HTML, extrair apenas o texto
                        const contentElement = document.getElementById(elementId);
                        const tempElement = document.createElement('div');
                        tempElement.innerHTML = contentElement.innerHTML;
                        textToCopy = tempElement.innerText || tempElement.textContent;
                    } else {
                        // Para outros tipos, pegar o conteúdo direto
                        const contentElement = document.getElementById(elementId);
                        textToCopy = contentElement.textContent || contentElement.innerText;
                    }
                    
                    // Copiar para área de transferência
                    navigator.clipboard.writeText(textToCopy).then(function() {
                        // Mostrar feedback de sucesso
                        showCopyFeedback(feedbackMessage);
                    }).catch(function(err) {
                        console.error('Erro ao copiar: ', err);
                        showCopyFeedback('Erro ao copiar', 'error');
                    });
                }
                
                function showCopyFeedback(message, type = 'success') {
                    // Create elemento de feedback
                    const feedback = document.createElement('div');
                    feedback.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed copy-feedback`;
                    feedback.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 280px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                    feedback.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'} me-2" style="font-size: 1.1em;"></i>
                            <span>${message}</span>
                            <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    
                    // Adicionar ao body
                    document.body.appendChild(feedback);
                    
                    // Remover automaticamente após 3 segundos
                    setTimeout(() => {
                        if (feedback && feedback.parentNode) {
                            feedback.classList.remove('show');
                            setTimeout(() => {
                                if (feedback && feedback.parentNode) {
                                    feedback.parentNode.removeChild(feedback);
                                }
                            }, 150);
                        }
                    }, 3000);
                }
                </script>
                
                <!-- Área de SEO -->
                {% if post.seo_title or post.seo_description %}
                    <div class="mt-4">
                        <h5>SEO</h5>
                        <div class="row">
                            {% if post.seo_title %}
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label mb-0"><strong>Title SEO:</strong></label>
                                        <button type="button" class="btn btn-outline-secondary btn-sm copy-btn" 
                                                onclick="copyContent(null, 'direct', '{{ post.seo_title|escapejs }}')"
                                                title="Copiar título SEO">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <div class="border rounded p-2 bg-light">
                                        {{ post.seo_title }}
                                        <small class="text-muted d-block">({{ post.seo_title|length }}/60 caracteres)</small>
                                    </div>
                                </div>
                            {% endif %}
                            {% if post.seo_description %}
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <label class="form-label mb-0"><strong>Description SEO:</strong></label>
                                        <button type="button" class="btn btn-outline-secondary btn-sm copy-btn" 
                                                onclick="copyContent(null, 'direct', '{{ post.seo_description|escapejs }}')"
                                                title="Copiar descrição SEO">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                    </div>
                                    <div class="border rounded p-2 bg-light">
                                        {{ post.seo_description }}
                                        <small class="text-muted d-block">({{ post.seo_description|length }}/160 caracteres)</small>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Link relacionado -->
                {% if post.link %}
                    <div class="mt-4">
                        <h5>Link Relacionado</h5>
                        <div class="border rounded p-2 bg-light">
                            <a href="{{ post.link }}" target="_blank" class="text-decoration-none">
                                {{ post.link }}
                                <i class="bi bi-box-arrow-up-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Informações de agendamento -->
                {% if post.scheduled_date and post.status == 'scheduled' %}
                    <div class="mt-4">
                        <div class="alert alert-info">
                            <i class="bi bi-calendar-event me-2"></i>
                            <strong>Scheduled para:</strong> {{ post.scheduled_date|date:"m/d/Y H:i" }}
                        </div>
                    </div>
                {% endif %}                
            </div>
        </div>
        
        <!-- Seção de estatísticas de caracteres -->
        {% if post.post_type == 'simple' %}
            <div class="card mt-3">
                <div class="card-body">
                    <h6>Estatísticas do Post</h6>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <strong class="{% if post.content|length > 1300 %}text-danger{% elif post.content|length > 1000 %}text-warning{% else %}text-success{% endif %}">
                                {{ post.content|length }}
                            </strong>
                            <br>
                            <small class="text-muted">Caracteres (máx. 1300)</small>
                        </div>
                        <div class="col-md-4">
                            <strong>{{ post.content|wordcount }}</strong>
                            <br>
                            <small class="text-muted">Palavras</small>
                        </div>
                        <div class="col-md-4">
                            <strong>{{ post.content|linebreaks|length }}</strong>
                            <br>
                            <small class="text-muted">Linhas</small>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Sidebar com informações -->
    <div class="col-md-4">
        <!-- Estatísticas do Content -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Estatísticas do Content</h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="border-end">
                            <h5 class="text-primary mb-1">{{ post.content|length|floatformat:0 }}</h5>
                            <small class="text-muted">Caracteres</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <h5 class="text-info mb-1">{{ post.content|wordcount }}</h5>
                        <small class="text-muted">Palavras</small>
                    </div>
                </div>
                
                <div class="row text-center">
                    <div class="col-6 mb-2">
                        <div class="border-end">
                            <h6 class="text-success mb-1">{{ post.content|linebreaksbr|length|floatformat:0 }}</h6>
                            <small class="text-muted">Com formatação</small>
                        </div>
                    </div>
                    <div class="col-6 mb-2">
                        <h6 class="text-warning mb-1">{{ post.content|striptags|length|floatformat:0 }}</h6>
                        <small class="text-muted">Texto puro</small>
                    </div>
                </div>
                
                <hr class="my-2">
                
                <!-- Estimativa de tempo de leitura -->
                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        Tempo estimado de leitura: 
                        <strong>{% widthratio post.content|wordcount 200 1 %} min</strong>
                    </small>
                </div>
                
                <!-- Indicador de tamanho -->
                <div class="mt-2">
                    <div class="d-flex justify-content-between">
                        <small class="text-muted">Tamanho:</small>
                        <span class="badge bg-{% if post.content|length < 500 %}warning{% elif post.content|length < 2000 %}info{% else %}success{% endif %}">
                            {% if post.content|length < 500 %}
                                Curto
                            {% elif post.content|length < 2000 %}
                                Médio
                            {% else %}
                                Longo
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Informações gerais -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Informações</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Tema:</strong><br>
                    <a href="{% url 'theme_detail' post.theme.id %}" class="text-decoration-none">
                        {{ post.theme.title }}
                    </a>
                </div>
                
                <div class="mb-3">
                    <strong>Tópico:</strong><br>
                    {{ post.topic }}
                </div>
                {% if post.ai_model_used %}
                    <div class="mb-3">
                        <strong>Modelo usado:</strong><br>
                        <code>{{ post.ai_model_used }}</code>
                    </div>
                {% endif %}
                
                <hr>
                
                <small class="text-muted">
                    <strong>Created:</strong> {{ post.created_at|date:"m/d/Y H:i" }}<br>
                    <strong>Modificado:</strong> {{ post.updated_at|date:"m/d/Y H:i" }}<br>
                    {% if post.generated_at %}
                        <strong>Generated por IA:</strong> {{ post.generated_at|date:"m/d/Y H:i" }}<br>
                    {% endif %}
                    {% if post.status == 'published' %}
                        <strong>Published:</strong> {{ post.post_date|date:"m/d/Y H:i" }}<br>
                    {% endif %}
                </small>
            </div>
        </div>
        
        <!-- Análise de Content -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Análise de Content</h6>
            </div>
            <div class="card-body">
                <!-- Score de completude -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Completude</small>
                        <small class="text-muted">
                            {% if post.content|length > 1500 and post.title|length > 10 %}
                                85%
                            {% elif post.content|length > 800 %}
                                70%
                            {% elif post.content|length > 300 %}
                                50%
                            {% else %}
                                25%
                            {% endif %}
                        </small>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar bg-{% if post.content|length > 1500 %}success{% elif post.content|length > 800 %}info{% elif post.content|length > 300 %}warning{% else %}danger{% endif %}" 
                             style="width: {% if post.content|length > 1500 %}85{% elif post.content|length > 800 %}70{% elif post.content|length > 300 %}50{% else %}25{% endif %}%"></div>
                    </div>
                </div>
                
                <!-- Características do conteúdo -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="mb-2">
                            {% if post.content|wordcount > 500 %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                            {% elif post.content|wordcount > 200 %}
                                <i class="bi bi-dash-circle-fill text-warning"></i>
                            {% else %}
                                <i class="bi bi-x-circle-fill text-danger"></i>
                            {% endif %}
                        </div>
                        <small class="text-muted">Extensão</small>
                    </div>
                    <div class="col-4">
                        <div class="mb-2">
                            {% if post.title|length > 5 and post.title|length < 60 %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                                <i class="bi bi-exclamation-circle-fill text-warning"></i>
                            {% endif %}
                        </div>
                        <small class="text-muted">Title</small>
                    </div>
                    <div class="col-4">
                        <div class="mb-2">
                            {% if post.post_type == 'article' and post.content|length > 1000 %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                            {% elif post.post_type == 'simple' and post.content|length > 200 %}
                                <i class="bi bi-check-circle-fill text-success"></i>
                            {% else %}
                                <i class="bi bi-info-circle-fill text-info"></i>
                            {% endif %}
                        </div>
                        <small class="text-muted">Tipo</small>
                    </div>
                </div>
                
                <!-- Sugestões -->
                <hr class="my-2">
                <div class="text-center">
                    <small class="text-muted">
                        {% if post.content|length < 300 %}
                            <i class="bi bi-lightbulb text-warning"></i>
                            Considere expandir o conteúdo
                        {% elif post.content|length > 3000 %}
                            <i class="bi bi-scissors text-info"></i>
                            Content pode ser dividido em partes
                        {% else %}
                            <i class="bi bi-check2 text-success"></i>
                            Tamanho adequado para {{ post.get_post_type_display|lower }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Métricas de SEO -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Métricas de SEO</h6>
            </div>
            <div class="card-body">
                <!-- Title -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Title ({{ post.title|length }} chars)</small>
                        <span class="badge bg-{% if post.title|length >= 30 and post.title|length <= 60 %}success{% elif post.title|length >= 20 and post.title|length <= 70 %}warning{% else %}danger{% endif %}">
                            {% if post.title|length >= 30 and post.title|length <= 60 %}
                                Ótimo
                            {% elif post.title|length >= 20 and post.title|length <= 70 %}
                                Bom
                            {% else %}
                                Revisar
                            {% endif %}
                        </span>
                    </div>
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-{% if post.title|length >= 30 and post.title|length <= 60 %}success{% elif post.title|length >= 20 and post.title|length <= 70 %}warning{% else %}danger{% endif %}" 
                             style="width: {% widthratio post.title|length 70 100 %}%"></div>
                    </div>
                </div>
                
                <!-- Densidade de conteúdo -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Densidade</small>
                        <small class="text-muted">
                            {{ post.content|content_density }}‰
                        </small>
                    </div>
                </div>
                
                <!-- Estrutura do conteúdo -->
                <div class="row text-center">
                    <div class="col-4">
                        <div class="mb-1">
                            <strong class="text-primary">{{ post.content|paragraph_count }}</strong>
                        </div>
                        <small class="text-muted">Parágrafos</small>
                    </div>
                    <div class="col-4">
                        <div class="mb-1">
                            <strong class="text-info">{{ post.content|sentence_count }}</strong>
                        </div>
                        <small class="text-muted">Sentenças</small>
                    </div>
                    <div class="col-4">
                        <div class="mb-1">
                            <strong class="text-success">{{ post.content|words_per_sentence }}</strong>
                        </div>
                        <small class="text-muted">Palavras/Sent.</small>
                    </div>
                </div>
                
                <!-- Legibilidade -->
                <hr class="my-2">
                <div class="text-center">
                    <small class="text-muted">
                        <i class="bi bi-eye me-1"></i>
                        Legibilidade: 
                        {% with difficulty=post.content|reading_difficulty %}
                            <span class="text-{% if difficulty == 'Fácil' %}success{% elif difficulty == 'Média' %}info{% else %}warning{% endif %}">
                                {{ difficulty }}
                            </span>
                        {% endwith %}
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Ações rápidas -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">Ações</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'post_edit' post.id %}" class="btn btn-primary">
                        <i class="bi bi-pencil me-2"></i>Edit Post
                    </a>
                    <form method="post" action="{% url 'post_delete' post.id %}" onsubmit="return confirm('Tem certeza que deseja remover este post?')" class="mt-2">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="bi bi-trash me-2"></i>Remover Post
                        </button>
                    </form>
                    
                    {% if post.status != 'published' %}
                        <form method="post" action="{% url 'post_publish' post.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success w-100" onclick="return confirm('Tem certeza que deseja publicar este post?')">
                                <i class="bi bi-send me-2"></i>Publish Agora
                            </button>
                        </form>

                    {% endif %}
                    
                    <a href="{% url 'theme_detail' post.theme.id %}" class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left me-2"></i>Voltar ao Tema
                    </a>
                    
                    <a href="{% url 'post_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-list me-2"></i>Ver Todos os Posts
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar se há task ID na mensagem para fazer polling
    const messages = document.querySelectorAll('.alert');
    let taskId = null;
    
    // Procurar task ID nas mensagens
    messages.forEach(function(message) {
        const text = message.textContent;
        const taskMatch = text.match(/Task ID: ([a-f0-9\-]+)/);
        if (taskMatch) {
            taskId = taskMatch[1];
        }
    });
    
    // Se há processing ou task ID, iniciar polling
    const isProcessing = {% if post.is_processing %}true{% else %}false{% endif %};
    
    if (isProcessing || taskId) {
        startPostPolling(taskId);
    }
    
    function startPostPolling(taskId) {
        const pollingInterval = 3000; // 3 segundos
        let pollCount = 0;
        const maxPolls = 60; // Máximo 3 minutos
        
        console.log('Iniciando polling para post task:', taskId);
        
        const poll = setInterval(function() {
            pollCount++;
            
            // Verificar se não excedeu o limite
            if (pollCount > maxPolls) {
                console.log('Polling interrupted: time limit exceeded');
                clearInterval(poll);
                showPollingTimeout();
                return;
            }
            
            // Fazer requisição para verificar status do post
            fetch(`/tasks/status/?post_id={{ post.id }}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Status do post:', data);
                    
                    if (data.status === 'completed' || data.status === 'success') {
                        console.log('Task do post concluída! Recarregando página...');
                        clearInterval(poll);
                        showSuccessMessage();
                        
                        // Recarregar página após breve delay
                        setTimeout(function() {
                            window.location.reload();
                        }, 2000);
                        
                    } else if (data.status === 'failed' || data.status === 'error') {
                        console.log('Task do post falhou:', data.error);
                        clearInterval(poll);
                        showErrorMessage(data.error);
                        
                        // Recarregar página para atualizar status
                        setTimeout(function() {
                            window.location.reload();
                        }, 5000);
                    }
                    // Se ainda está processando, continuar polling
                })
                .catch(error => {
                    console.error('Polling error:', error);
                    // Continuar tentando em caso de erro de rede
                });
        }, pollingInterval);
    }
    
    function showSuccessMessage() {
        const banner = document.getElementById('processing-banner');
        if (banner) {
            banner.className = 'alert alert-success fade show';
            banner.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-check-circle-fill me-3 text-success"></i>
                    <div>
                        <strong>Completed!</strong> 
                        <span>O post foi processado com sucesso. A página será atualizada em instantes.</span>
                    </div>
                </div>
            `;
        }
    }
    
    function showErrorMessage(error) {
        const banner = document.getElementById('processing-banner');
        if (banner) {
            banner.className = 'alert alert-danger fade show';
            banner.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-3 text-danger"></i>
                    <div>
                        <strong>Erro!</strong> 
                        <span>Ocorreu um erro durante o processamento: ${error || 'Erro desconhecido'}</span>
                    </div>
                </div>
            `;
        }
    }
    
    function showPollingTimeout() {
        const banner = document.getElementById('processing-banner');
        if (banner) {
            banner.className = 'alert alert-warning fade show';
            banner.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-clock-fill me-3 text-warning"></i>
                    <div>
                        <strong>Tempo Limite!</strong> 
                        <span>O processamento está demorando mais que o esperado. Recarregue a página para verificar o status.</span>
                        <button onclick="window.location.reload()" class="btn btn-warning btn-sm ms-2">Recarregar</button>
                    </div>
                </div>
            `;
        }
    }
});
</script>
{% endblock %}
