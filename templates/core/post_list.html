{% extends 'core/base.html' %}

{% block title %}Posts - Post Pilot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Posts</h1>
            <a href="{% url 'theme_list' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Create Posts via Tema
            </a>
        </div>
    </div>
</div>

{% if posts %}
    <!-- Filtros rápidos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <h6>Filtrar por tipo:</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" onclick="filterPosts('all')">
                                    Todos
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="filterPosts('simple')">
                                    Posts Simples
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="filterPosts('article')">
                                    Artigos
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <h6>Filtrar por status:</h6>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" onclick="filterStatus('all')">
                                    Todos
                                </button>
                                <button type="button" class="btn btn-outline-success" onclick="filterStatus('published')">
                                    Publisheds
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="filterStatus('generated')">
                                    Generateds
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="filterStatus('draft')">
                                    Drafts
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Buscar:</h6>
                            <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Search by title, content or topic..." onkeyup="searchPosts()">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="postsContainer">
        {% for post in posts %}
            <div class="col-lg-6 mb-4 post-item" 
                 data-type="{{ post.post_type }}" 
                 data-status="{{ post.status }}"
                 data-search="{{ post.title|lower }} {{ post.content|lower }} {{ post.topic|lower }}">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-{% if post.post_type == 'article' %}info{% else %}primary{% endif %} me-2">
                                {{ post.get_post_type_display }}
                            </span>
                            <span class="badge bg-{% if post.status == 'published' %}success{% elif post.status == 'generated' %}warning{% elif post.status == 'scheduled' %}info{% else %}secondary{% endif %}">
                                {{ post.get_status_display }}
                            </span>
                        </div>
                        <small class="text-muted">{{ post.created_at|date:"d/m/Y" }}</small>
                    </div>
                    
                    <div class="card-body">
                        <h5 class="card-title">
                            <a href="{% url 'post_detail' post.id %}" class="text-decoration-none">
                                {{ post.title }}
                            </a>
                        </h5>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <strong>Tema:</strong> 
                                <a href="{% url 'theme_detail' post.theme.id %}" class="text-decoration-none">
                                    {{ post.theme.title }}
                                </a>
                            </small>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">
                                <strong>Tópico:</strong> {{ post.topic }}
                            </small>
                        </div>
                        
                        <p class="card-text">{{ post.content_preview }}</p>
                        
                        {% if post.seo_title %}
                            <div class="mb-2">
                                <small class="text-muted">
                                    <strong>SEO:</strong> {{ post.seo_title }}
                                </small>
                            </div>
                        {% endif %}
                        
                        {% if post.link %}
                            <div class="mb-2">
                                <small>
                                    <strong>Link:</strong> 
                                    <a href="{{ post.link }}" target="_blank" class="text-decoration-none">
                                        {{ post.link|truncatechars:40 }}
                                        <i class="bi bi-box-arrow-up-right"></i>
                                    </a>
                                </small>
                            </div>
                        {% endif %}
                        
                        {% if post.scheduled_date and post.status == 'scheduled' %}
                            <div class="mb-2">
                                <small class="text-info">
                                    <i class="bi bi-calendar-event me-1"></i>
                                    <strong>Scheduled para:</strong> {{ post.scheduled_date|date:"m/d/Y H:i" }}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                {% if post.generated_at %}
                                    <small class="text-muted">
                                        <i class="bi bi-robot me-1"></i>Generated em {{ post.generated_at|date:"m/d/Y H:i" }}
                                    </small>
                                {% endif %}
                            </div>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'post_detail' post.id %}" class="btn btn-outline-primary">Ver</a>
                                <a href="{% url 'post_edit' post.id %}" class="btn btn-outline-secondary">Edit</a>
                                {% if post.status != 'published' %}
                                    <form method="post" action="{% url 'post_publish' post.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-success" onclick="return confirm('Tem certeza que deseja publicar este post?')">
                                            Publish
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Estatísticas gerais -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-info">
                <h6 class="alert-heading">
                    <i class="bi bi-graph-up me-2"></i>Estatísticas Gerais
                </h6>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Total de Posts:</strong> {{ posts|length }}
                    </div>
                    <div class="col-md-3">
                        <strong>Publisheds:</strong> 
                        {% with published_count=posts|length %}
                            {% for post in posts %}
                                {% if post.status == 'published' %}{{ forloop.counter0|add:1 }}{% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>
                    <div class="col-md-3">
                        <strong>Artigos:</strong> 
                        {% with article_count=0 %}
                            {% for post in posts %}
                                {% if post.post_type == 'article' %}{{ forloop.counter0|add:1 }}{% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>
                    <div class="col-md-3">
                        <strong>Posts Simples:</strong> 
                        {% with simple_count=0 %}
                            {% for post in posts %}
                                {% if post.post_type == 'simple' %}{{ forloop.counter0|add:1 }}{% endif %}
                            {% endfor %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    </div>

{% else %}
    <!-- Estado vazio -->
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-file-text text-muted" style="font-size: 4rem;"></i>
                <h3 class="text-muted mt-3">No posts created yet</h3>
                <p class="text-muted mb-4">
                    Crie temas e gere posts automaticamente com IA para começar.
                </p>
                <a href="{% url 'theme_create' %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>Create Primeiro Tema
                </a>
            </div>
        </div>
    </div>
{% endif %}

<script>
function filterPosts(type) {
    const posts = document.querySelectorAll('.post-item');
    const buttons = document.querySelectorAll('[onclick^="filterPosts"]');
    
    // Remove active class from all buttons
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    posts.forEach(post => {
        if (type === 'all' || post.dataset.type === type) {
            post.style.display = 'block';
        } else {
            post.style.display = 'none';
        }
    });
}

function filterStatus(status) {
    const posts = document.querySelectorAll('.post-item');
    const buttons = document.querySelectorAll('[onclick^="filterStatus"]');
    
    // Remove active class from all buttons
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Add active class to clicked button
    event.target.classList.add('active');
    
    posts.forEach(post => {
        if (status === 'all' || post.dataset.status === status) {
            post.style.display = 'block';
        } else {
            post.style.display = 'none';
        }
    });
}

function searchPosts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const posts = document.querySelectorAll('.post-item');
    
    posts.forEach(post => {
        const searchData = post.dataset.search;
        if (searchData.includes(searchTerm)) {
            post.style.display = 'block';
        } else {
            post.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
